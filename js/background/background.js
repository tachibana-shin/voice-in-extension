const DEBUG=!1;var settings=null,recognizer=null;const isEdge=window.navigator.userAgent.indexOf("Edg")>-1,baseURL="https://dictanote.co";function checkTab(e){return!(!settings||!settings.tabChangeOk)||void 0!==e&&null!=e&&!(e.length<1)&&e[0].id===settings.currentTabId}function checkTabId(e){return!(!settings||!settings.tabChangeOk)||e===settings.currentTabId}function getShortcut(e){chrome.commands.getAll((t=>{chrome.tabs.sendMessage(e,{action:"set_shortcut",shortcut:t})}))}function notifyLangUpdate(e){console.debug("notifying update",e),chrome.tabs.query({active:!0,currentWindow:!0},(e=>{checkTab(e)?chrome.tabs.sendMessage(e[0].id,{action:"lang_update"}):console.debug("ignoring update")}))}function switchLang(e){console.log("Updating lang to ",e),settings.updateLanguage(e),recognizer.isListening&&recognizer.restart(),notifyLangUpdate(e)}function sendResult(e){chrome.tabs.query({active:!0,currentWindow:!0},(t=>checkTab(t)?chrome.tabs.sendMessage(t[0].id,{action:"on_results",txtToAdd:e}):recognizer.stop()))}function sendInterimResult(e){chrome.tabs.query({active:!0,currentWindow:!0},(t=>checkTab(t)?chrome.tabs.sendMessage(t[0].id,{action:"on_interim_results",txtToAdd:e}):recognizer.stop()))}function applyVC(e){function t(e,t,s,n){return e.substring(0,t)+n+e.substring(s)}let s=e,n=e.toLocaleLowerCase();"sc"===settings.changeCase||"lc"===settings.changeCase?s=s.toLocaleLowerCase():"uc"===settings.changeCase&&(s=s.toLocaleUpperCase());const o=-1!==["yue-Hant-HK","ja-JP","cmn-Hans-HK","cmn-Hans-CN"].indexOf(settings.currentLang);function a(e){e.forEach((e=>{const a=e[1];if(-1!==n.indexOf(a)){let i=e[0],r=!1;"string"!=typeof i&&(i=i[0],r=!0);let c=!0,g=0;for(;c;){const e=n.indexOf(a,g);if(-1!==e)if(o||r||(0===e||" "===n[e-1])&&(e+a.length===n.length||" "===n[e+a.length])){let o=e,r=e+a.length;0!==o&&-1!==[".",",",";",":","?","!",")","’","”","-","–"].indexOf(i[0])&&" "===n[o-1]&&(o-=1),r!==n.length&&-1!==["(","/","‘","“","-","–"].indexOf(i[i.length-1])&&" "===n[r]&&(r+=1),s=t(s,o,r,i),n=t(n,o,r,i),g=e+i.length}else g=e+a.length;else c=!1}}}))}if(settings.isPro){a(settings.voiceCommands)}return Utils.getDefaultVoiceCommands(settings.currentLang).forEach((e=>{a(e.entries)})),s=s.replace(/\n\n/g,"<newparagraph>"),s=s.replace(/\n/g,"<newline>"),settings.disableDiacritics&&(s=s.normalize("NFD").replace(/[\u0300-\u036f]/g,"")),s}function onRecognizerResult(e){if(void 0===e.results)return recognizer.recognition.onend=null,void recognizer.recognition.stop();recognizer.lastRecognized=Date.now();let t="",s="";for(let n=e.resultIndex;n<e.results.length;n+=1){const o=e.results[n][0].transcript;e.results[n].isFinal?t+=o:s+=o}if(s&&sendInterimResult(s),t){if(isEdge){const e=".?";t.length>0&&e.indexOf(t[t.length-1])>-1&&(t=t.substring(0,t.length-1))}const e=applyVC(t);sendResult(Utils.trimSpacesOnly(e))}}function activatePlus(){settings.loadAll(),chrome.tabs.query({},(e=>{for(let t=0;t<e.length;t+=1)chrome.tabs.sendMessage(e[t].id,{action:"plus_activated"})}))}function updateTabChangeOk(e){console.debug("Updating tabChangeOk to ",e),settings.updateTabChangeOk(e)}function updateChangeCase(e){console.debug("Updating changeCase to ",e),settings.updateChangeCase(e)}Utils.isInCompatible()?(chrome.browserAction.setIcon({path:"/images/ic_mic_disabled_36dp.png"}),chrome.browserAction.setPopup({popup:"badbrowser.html"})):((settings=new Settings).loadAll(),recognizer=new Recognizer(settings),settings.recognizer=recognizer,recognizer.setOnResult(onRecognizerResult),chrome.runtime.setUninstallURL(baseURL+"/voicein/feedback/"),chrome.commands.onCommand.addListener((e=>{switch(console.log("Background Command",e),e){case"lang1_ks":settings.isPro&&switchLang(settings.lang1);break;case"lang2_ks":settings.isPro&&switchLang(settings.lang2);break;case"lang3_ks":settings.isPro&&switchLang(settings.lang3)}})),chrome.tabs.onRemoved.addListener((e=>{recognizer.isListening&&!checkTabId(e)&&recognizer.stop()})),chrome.runtime.onInstalled.addListener((e=>{if(console.log(e),"install"===e.reason)chrome.tabs.create({url:`chrome-extension://${chrome.runtime.id}/setup.html`},(()=>{console.log(chrome.runtime.id)})),chrome.windows.getAll({populate:!0},(e=>{for(let t=0;t<e.length;t+=1){const s=e[t];for(let e=0;e<s.tabs.length;e+=1){const t=s.tabs[e];if(!t.url.match(/(chrome):\/\//gi)){const e=()=>{chrome.tabs.sendMessage(t.id,{action:"tab_url_change",url:t.url,recognizing:recognizer.isListening},(()=>{}))};console.log("Injecting scripts into ",t.url),Utils.injectIntoTab(t,e)}}}}));else if("update"===e.reason){const t=chrome.app.getDetails().version,s=e.previousVersion;t!==s&&(console.log(`Extension Update PrevVersion=${s} CurVersion=${t}`),chrome.storage.sync.get(["pro","expiry","code"],(e=>{if(e.pro){const t=e.expiry,s=e.code;if(!s)return console.log("Code missing"),chrome.storage.sync.set({pro:true}),void(settings.pro=true);const n=new FormData;n.append("code",s),fetch(baseURL+"/voicein/activate/",{method:"post",body:n}).then((e=>e.json())).then((e=>{"success"===e.type?"active"===e.status?e.expiry!==t&&(console.log(`Prev expiry: ${t}, Cur Expiry: ${e.expiry}`),chrome.storage.sync.set({pro:!0,code:s,expiry:e.expiry},(()=>{console.log("User's Plus Lease Renewed to "+e.expiry)}))):(console.log("User's Plus has expired"),chrome.storage.sync.set({pro:true}),settings.pro=true):"error"===e.type&&(console.log("User's Plus doesn't exist"),chrome.storage.sync.set({pro:true}),settings.pro=true)})).catch((e=>{console.log("Error checking user's license details")}))}}))),chrome.storage.sync.get("no_advancedmode_domains",(e=>{e.no_advancedmode_domains||chrome.storage.sync.get("no_pastemode_domains",(e=>{if(e.no_pastemode_domains){const t=e.no_pastemode_domains;chrome.storage.sync.set({no_advancedmode_domains:t},(()=>{}))}}))}))}})),chrome.runtime.onMessage.addListener(((e,t,s)=>{switch(console.log("Background",e,t),e.message_id){case"update_language":switchLang(e.language);break;case"update_tab_change_ok":updateTabChangeOk(e.tabChangeOk);break;case"get_shortcut":t&&t.tab&&t.tab.id&&getShortcut(t.tab.id);break;case"update_vc":settings.loadVC();break;case"update_ls":settings.loadLS();break;case"update_change_case":updateChangeCase(e.changeCase);break;case"update_diacritics":settings.loadDiacritics();break;case"stop_recognition":recognizer.stopRecognition();break;case"reload":console.log("Reloading - Setting Pro"),activatePlus();break;case"track":gaLog(e.category,e.action,e.label,e.interaction);break;case"mp_track":mpTrack(e.category,e.info);break;case"copy_text":Utils.writeText(e.value).then((()=>{s({status:"success"})}))}return!0})),chrome.runtime.onMessageExternal.addListener(((e,t,s)=>{if(e&&e.message)if("version"===e.message)s({version:1});else if("upgradePlus"===e.message){const t=e.code,n=new FormData;return n.append("code",t),fetch(baseURL+"/voicein/activate/",{method:"post",body:n}).then((e=>e.json())).then((e=>{"success"===e.type&&"active"===e.status?chrome.storage.sync.set({pro:!0,code:t,activated:(new Date).getTime(),expiry:e.expiry},(()=>{console.log("Reloading - Setting Pro"),s({status:"success"}),activatePlus()})):s({status:"error"})})).catch((e=>{s({status:"error"})})),!0}return!0})),chrome.tabs.onUpdated.addListener(((e,t,s)=>{"complete"===t.status&&(void 0===s.url||(null!=s.url.match("chrome.google.com")||null!=s.url.match(/chrome:\/\//)?(chrome.browserAction.setIcon({path:"/images/ic_mic_disabled_36dp.png",tabId:e}),chrome.browserAction.setPopup({tabId:e,popup:"disabled.html"})):chrome.tabs.sendMessage(e,{action:"tab_url_change",url:s.url,recognizing:recognizer.isListening})))})),chrome.tabs.onActivated.addListener((e=>{console.debug("onActivated",e);var t=checkTabId(e.tabId);t?chrome.tabs.sendMessage(e.tabId,{action:"tab_activated",recognizing:recognizer.isListening}):recognizer.isListening&&!t&&recognizer.stop()})));